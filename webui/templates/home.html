<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home - Traefik Manager</title>
    <style>
        body { font-family: sans-serif; margin: 0; background-color: #f4f4f4; color: #333; }
        .navbar { background-color: #2c3e50; overflow: hidden; padding: 10px 20px; color: white; }
        .navbar .user-info { float: left; }
        .navbar .logout-link { float: right; color: white; text-decoration: none; padding: 14px 0;}
        .navbar a:hover { text-decoration: underline; }
        .container { padding: 20px; max-width: 900px; margin: 20px auto; background-color: #fff; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .alert { padding: 15px; margin-bottom: 20px; border-radius: 4px; border: 1px solid transparent; }
        .alert-success { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
        .alert-danger { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .alert-info { background-color: #d1ecf1; color: #0c5460; border-color: #bee5eb; }
        .alert-warning { background-color: #fff3cd; color: #856404; border-color: #ffeeba; }
        .service-status { margin-top: 20px; padding: 15px; background-color: #e9ecef; border-radius: 4px; }
        .service-status h3 { margin-top: 0; }
        .service-status p { font-size: 1.1em; }
        .service-status .status-value { font-weight: bold; }
        .status-active { color: #28a745; }
        .status-inactive { color: #dc3545; }
        .status-unknown { color: #6c757d; }
        .action-buttons button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; font-size: 1em; }
        .action-buttons button:hover { background-color: #0056b3; }
        .action-buttons .btn-stop { background-color: #dc3545; }
        .action-buttons .btn-stop:hover { background-color: #c82333; }
        .action-buttons .btn-restart { background-color: #ffc107; color: #212529; }
        .action-buttons .btn-restart:hover { background-color: #e0a800; }
        #messages { margin-top: 20px; }
        /* Styles for route management and modal */
        #route-table { width:100%; border-collapse: collapse; margin-top:15px; }
        #route-table th, #route-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        #route-table th { background-color: #e9ecef; }
        #view-config-modal { display:none; position:fixed; z-index:100; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,0.4); }
        .modal-content { background-color:#fefefe; margin:5% auto; padding:20px; border:1px solid #888; width:80%; max-width:700px; border-radius:8px; position:relative; box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19); }
        .close-button { color:#aaa; float:right; font-size:28px; font-weight:bold; cursor:pointer; }
        .close-button:hover, .close-button:focus { color:black; text-decoration:none; }
        #modal-config-content { background-color:#f8f9fa; padding:15px; border-radius:4px; max-height:400px; overflow-y:auto; border:1px solid #eee; white-space: pre-wrap; word-wrap: break-word; }
        #add-route-form-container { margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 5px; border: 1px solid #eee; }
        #add-route-form-container label { display: block; margin-bottom: 5px; font-weight: bold;}
        #add-route-form-container input[type="text"], #add-route-form-container input[type="checkbox"] { margin-bottom: 10px; }
        #add-route-form-container input[type="text"] { width: calc(100% - 16px); padding: 8px; border: 1px solid #ccc; border-radius: 4px;}
        #add-route-form-container button { background-color: #28a745; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; }
        #add-route-form-container button:hover { background-color: #218838; }
        #add-route-form-container .checkbox-group label { font-weight: normal; display: inline; margin-left: 5px; }
        #add-route-form-container .checkbox-container { margin-bottom: 10px;}
        #add-route-form-container .sub-checkbox-container { padding-left: 20px; margin-bottom:10px; }
        /* Styles for certificate info */
        #certificate-info-container table { width:100%; border-collapse: collapse; margin-top:15px; }
        #certificate-info-container th, #certificate-info-container td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        #certificate-info-container th { background-color: #e9ecef; }
        /* Styles for log viewer */
        #log-content-area { background-color: #111; color: #eee; padding: 15px; border-radius: 4px; max-height: 500px; overflow-y: auto; border: 1px solid #333; white-space: pre-wrap; word-wrap: break-word; }

    </style>
</head>
<body>
    <div class="navbar">
        <div class="user-info">Welcome, <strong>{{ username }}</strong>!</div>
        <a href="{{ url_for('logout') }}" class="logout-link">Logout</a>
    </div>

    <div class="container">
        <div id="messages">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
        </div>

        <h2>Traefik Service Management</h2>
        <div class="service-status">
            <h3>Current Status</h3>
            <p>Traefik Service: <span id="traefik-status-value" class="status-value status-unknown">Checking...</span></p>
            <pre id="traefik-status-output" style="background-color: #f8f9fa; padding: 10px; border-radius: 4px; max-height: 200px; overflow-y: auto; display: none;"></pre>
        </div>

        <div class="action-buttons" style="margin-top: 20px;">
            <button onclick="performServiceAction('start')">Start Traefik</button>
            <button onclick="performServiceAction('stop')" class="btn-stop">Stop Traefik</button>
            <button onclick="performServiceAction('restart')" class="btn-restart">Restart Traefik</button>
        </div>

        <hr style="margin-top: 30px; margin-bottom: 30px;">

        <h2>Route Management</h2>
        <button onclick="fetchRoutes()" style="margin-bottom: 15px;">Refresh Routes List</button>

        <div id="add-route-form-container">
            <h4>Add New Route</h4>
            <form id="addRouteForm">
                <div>
                    <label for="service_name">Service Name (e.g., my-app):</label>
                    <input type="text" id="service_name" name="service_name" required>
                </div>
                <div>
                    <label for="domain">Domain (e.g., app.example.com):</label>
                    <input type="text" id="domain" name="domain" required>
                </div>
                <div>
                    <label for="backend_target">Backend Target (e.g., 10.0.0.5:80 or internalhost:3000):</label>
                    <input type="text" id="backend_target" name="backend_target" required>
                </div>
                <div class="checkbox-container">
                    <input type="checkbox" id="backend_https" name="backend_https">
                    <label for="backend_https" class="checkbox-group">Backend uses HTTPS</label>
                </div>
                <div class="sub-checkbox-container">
                    <input type="checkbox" id="skip_verify" name="skip_verify">
                    <label for="skip_verify" class="checkbox-group">Skip Backend SSL Certificate Verification (if backend HTTPS)</label>
                </div>
                <button type="submit">Create Route</button>
            </form>
        </div>
        
        <div id="route-list-container">
            <table id="route-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Rule</th>
                        <th>Target(s)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="route-table-body">
                    <tr><td colspan="4" style="text-align:center; padding:10px;">Loading routes...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Modal for displaying YAML config -->
        <div id="view-config-modal">
            <div class="modal-content">
                <span class="close-button" onclick="closeConfigModal()">&times;</span>
                <h3 id="modal-title">View Configuration</h3>
                <pre id="modal-config-content"></pre>
            </div>
        </div>

        <hr style="margin-top: 30px; margin-bottom: 30px;">

        <h2>SSL/Certificate Information</h2>
        <button onclick="fetchCertificateInfo()" style="margin-bottom: 15px;">Refresh Certificate Info</button>
        <div id="certificate-info-container">
            <p>Loading certificate information...</p>
            <!-- Certificate details will be populated here -->
        </div>

        <hr style="margin-top: 30px; margin-bottom: 30px;">

        <h2>Log Viewer</h2>
        <div id="log-viewer-controls" style="margin-bottom: 15px;">
            <label for="log_type_select">Select Log Type:</label>
            <select id="log_type_select" style="margin-right: 10px; padding: 5px;">
                <option value="traefik">Traefik App Log (traefik.log)</option>
                <option value="access">Access Log (access.log)</option>
                <option value="ip_access">IP Access Log (ip_access.log)</option>
                <option value="journal">Systemd Journal (traefik.service)</option>
                <option value="autobackup_file">Autobackup File Log</option>
                <option value="autobackup">Autobackup Journal</option>
                <option value="ip_logger">IP Logger Journal</option>
            </select>
            <label for="log_lines_input">Lines:</label>
            <input type="number" id="log_lines_input" value="100" min="10" max="1000" style="width: 60px; margin-right: 10px; padding: 5px;">
            <button onclick="fetchLogs()">View Log</button>
        </div>
        <pre id="log-content-area" style="background-color: #111; color: #eee; padding: 15px; border-radius: 4px; max-height: 500px; overflow-y: auto; border: 1px solid #333; white-space: pre-wrap; word-wrap: break-word;"></pre>

    </div>

    <script>
        // Standard displayMessage function
        function displayMessage(message, category) {
            const messagesDiv = document.getElementById('messages');
            const oldMessages = messagesDiv.querySelectorAll('.dynamic-alert');
            oldMessages.forEach(m => m.remove());

            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-' + category + ' dynamic-alert';
            alertDiv.textContent = message;
            messagesDiv.appendChild(alertDiv);
            setTimeout(() => {
                alertDiv.style.opacity = '0';
                setTimeout(() => alertDiv.remove(), 500);
            }, 5000);
        }
        
        function escapeHtml(unsafe) {
            if (unsafe === null || typeof unsafe === 'undefined') {
                return '';
            }
            return unsafe
                 .toString()
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }

        // --- Traefik Service Management Script ---
        document.addEventListener('DOMContentLoaded', function() {
            fetchTraefikStatus();
            fetchRoutes(); // Fetch routes on page load
            fetchCertificateInfo(); // Fetch certificate info on page load

            // Add Route Form Submission Handler
            document.getElementById('addRouteForm').addEventListener('submit', async function(event) {
                event.preventDefault(); // Prevent default form submission

                const service_name = document.getElementById('service_name').value.trim();
                const domain = document.getElementById('domain').value.trim();
                const backend_target = document.getElementById('backend_target').value.trim();
                const backend_https = document.getElementById('backend_https').checked;
                const skip_verify = document.getElementById('skip_verify').checked;

                if (!service_name || !domain || !backend_target) {
                    displayMessage('Service Name, Domain, and Backend Target are required.', 'danger');
                    return;
                }
                // Basic check for backend_target format (host:port)
                if (!backend_target.includes(':')) {
                    displayMessage('Backend Target must be in host:port format (e.g., 192.168.1.10:80 or internalhost:3000).', 'danger');
                    return;
                }

                const payload = {
                    service_name,
                    domain,
                    backend_target,
                    backend_https,
                    skip_verify
                };

                displayMessage('Adding route ' + service_name + '...', 'info');

                try {
                    const response = await fetch('/api/routes/add', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload),
                    });
                    const data = await response.json();

                    if (data.success) {
                        displayMessage('Route ' + service_name + ' added successfully. Output: ' + data.stdout, 'success');
                        document.getElementById('addRouteForm').reset(); // Clear the form
                        fetchRoutes(); // Refresh the list
                    } else {
                        displayMessage('Error adding route ' + service_name + ': ' + (data.stderr || data.error || 'Unknown error'), 'danger');
                    }
                } catch (error) {
                    console.error('Error adding route:', error);
                    displayMessage('Network error or server not responding when adding route.', 'danger');
                }
            });
        });

        async function fetchTraefikStatus() {
            const statusValueEl = document.getElementById('traefik-status-value');
            const statusOutputEl = document.getElementById('traefik-status-output');
            statusValueEl.textContent = 'Checking...';
            statusValueEl.className = 'status-value status-unknown';
            statusOutputEl.style.display = 'none';

            try {
                const response = await fetch('/api/service/status');
                const data = await response.json();

                if (data.success) {
                    if (data.stdout.includes("active (running)")) {
                        statusValueEl.textContent = 'Active';
                        statusValueEl.className = 'status-value status-active';
                    } else if (data.stdout.includes("inactive (dead)") || data.stdout.includes("inactive")) {
                        statusValueEl.textContent = 'Inactive';
                        statusValueEl.className = 'status-value status-inactive';
                    } else {
                        statusValueEl.textContent = 'Unknown (See Details)';
                        statusValueEl.className = 'status-value status-unknown';
                    }
                    statusOutputEl.textContent = "Raw Output:\n" + data.stdout + (data.stderr ? "\nStderr:\n" + data.stderr : "");
                    statusOutputEl.style.display = 'block';

                } else {
                    statusValueEl.textContent = 'Error fetching status';
                    statusValueEl.className = 'status-value status-inactive';
                    statusOutputEl.textContent = "Error: " + (data.stderr || data.error || 'Unknown error');
                    statusOutputEl.style.display = 'block';
                    displayMessage('Failed to fetch Traefik status: ' + (data.stderr || data.error || 'Unknown error'), 'danger');
                }
            } catch (error) {
                statusValueEl.textContent = 'Error';
                statusValueEl.className = 'status-value status-inactive';
                displayMessage('Network error or server not responding while fetching status.', 'danger');
                console.error('Error fetching status:', error);
            }
        }

        async function performServiceAction(action) {
            const endpoint = '/api/service/' + action;
            displayMessage('Issuing ' + action + ' command...', 'info');

            try {
                const response = await fetch(endpoint, { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    displayMessage('Traefik service ' + action + ' command successful. STDOUT: ' + data.stdout, 'success');
                } else {
                    displayMessage('Error performing ' + action + ': ' + (data.stderr || data.error || 'Unknown error'), 'danger');
                }
            } catch (error) {
                displayMessage('Network error or server not responding during ' + action + '.', 'danger');
                console.error('Error performing action ' + action + ':', error);
            } finally {
                setTimeout(fetchTraefikStatus, 2000);
            }
        }

        // --- Route Management Script ---
        async function fetchRoutes() {
            const tableBody = document.getElementById('route-table-body');
            tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:10px;">Loading routes...</td></tr>';

            try {
                const response = await fetch('/api/routes');
                const data = await response.json();

                if (data.success && data.routes) {
                    tableBody.innerHTML = ''; 
                    if (data.routes.length === 0) {
                         let msg = 'No routes found.';
                         if(data.message && data.message.includes("directory not found")) {
                             msg = 'Dynamic configuration directory not found on server.';
                         } else if (data.message) {
                             msg = data.message;
                         }
                        tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:10px;">' + msg + '</td></tr>';
                    } else {
                        data.routes.forEach(route => {
                            const row = tableBody.insertRow();
                            row.insertCell().textContent = route.name || 'N/A';
                            row.insertCell().textContent = route.rule || 'N/A';
                            
                            let servicesText = 'N/A';
                            if (route.services && route.services.length > 0) {
                                servicesText = route.services.join(', ');
                            } else if (route.error) {
                                servicesText = 'Error: ' + route.error;
                                row.style.backgroundColor = '#ffebee'; // Light red for error rows
                            }
                            row.insertCell().textContent = servicesText;
                            
                            const actionsCell = row.insertCell();
                            if (!route.error) { // Only add view button if no error processing the route file
                                const viewButton = document.createElement('button');
                                viewButton.textContent = 'View Config';
                                viewButton.onclick = function() { openConfigModal(route.filename); };
                                viewButton.style.marginRight = '5px';
                                actionsCell.appendChild(viewButton);

                                const removeButton = document.createElement('button');
                                removeButton.textContent = 'Remove';
                                removeButton.style.backgroundColor = '#dc3545'; 
                                removeButton.style.color = 'white';
                                removeButton.onclick = function() { removeRoute(route.filename, route.name); };
                                actionsCell.appendChild(removeButton);
                            } else {
                                actionsCell.textContent = 'Invalid Config';
                            }
                        });
                    }
                } else {
                    tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:10px; color:red;">Error loading routes: ' + (data.message || data.error || 'Unknown error') + '</td></tr>';
                }
            } catch (error) {
                console.error('Error fetching routes:', error);
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:10px; color:red;">Client-side error fetching routes. Check console.</td></tr>';
                displayMessage('Network error or server not responding while fetching routes.', 'danger');
            }
        }

        async function openConfigModal(filename) {
            const modal = document.getElementById('view-config-modal');
            const titleEl = document.getElementById('modal-title');
            const contentEl = document.getElementById('modal-config-content');

            titleEl.textContent = 'View Configuration: ' + filename;
            contentEl.textContent = 'Loading content...';
            contentEl.style.color = 'inherit'; // Reset color
            modal.style.display = 'block';

            try {
                const response = await fetch('/api/routes/' + filename);
                const data = await response.json();

                if (data.success) {
                    contentEl.textContent = data.raw_content || 'Empty or no raw content found.';
                    if (data.parsing_error) {
                        contentEl.textContent += "\n\n--- PARSING ERROR ---\n" + data.parsing_error;
                        contentEl.style.color = 'red';
                    }
                } else {
                    contentEl.textContent = 'Error loading file content: ' + (data.error || 'Unknown error');
                    contentEl.style.color = 'red';
                    displayMessage('Failed to load config for ' + filename + ': ' + (data.error || 'Unknown error'), 'danger');
                }
            } catch (error) {
                console.error('Error fetching route content:', error);
                contentEl.textContent = 'Client-side error fetching file content. Check console.';
                contentEl.style.color = 'red';
                displayMessage('Network error or server not responding while fetching config for ' + filename + '.', 'danger');
            }
        }

        function closeConfigModal() {
            document.getElementById('view-config-modal').style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('view-config-modal');
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        async function removeRoute(filename, serviceName) {
            if (!window.confirm('Are you sure you want to remove the route config file "' + filename + '" for service "' + serviceName + '"? This action cannot be undone.')) {
                return;
            }

            displayMessage('Removing route ' + serviceName + ' (' + filename + ')..', 'info');

            try {
                const response = await fetch('/api/routes/remove', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ filename: filename }),
                });
                const data = await response.json();

                if (data.success) {
                    displayMessage('Route ' + serviceName + ' (' + filename + ') removed successfully. Output: ' + data.stdout, 'success');
                    fetchRoutes(); // Refresh the list
                } else {
                    displayMessage('Error removing route ' + serviceName + ': ' + (data.stderr || data.error || 'Unknown error'), 'danger');
                }
            } catch (error) {
                console.error('Error removing route:', error);
                displayMessage('Network error or server not responding when removing route.', 'danger');
            }
        }

        // --- SSL/Certificate Information Script ---
        async function fetchCertificateInfo() {
            const container = document.getElementById('certificate-info-container');
            container.innerHTML = '<p>Loading certificate information...</p>';

            try {
                const response = await fetch('/api/ssl/certificates');
                const data = await response.json();

                if (data.success && data.certificates) {
                    if (data.certificates.length === 0) {
                        container.innerHTML = '<p>No certificates found or reported by the script.</p>';
                        if(data.message && data.message.length > 0 && !data.message.includes("No certificates found")){
                             container.innerHTML += '<pre style="background-color: #f8f9fa; padding: 10px; border-radius: 4px;">' + escapeHtml(data.message) + '</pre>';
                        }
                        return;
                    }

                    let html = '<table style="width:100%; border-collapse: collapse;">';
                    html += '<thead><tr>' +
                            '<th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Main Domain</th>' +
                            '<th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Alternatives</th>' +
                            '<th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Issuer</th>' +
                            '<th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Valid Until</th>' +
                            '</tr></thead><tbody>';

                    data.certificates.forEach(cert => {
                        html += '<tr>';
                        html += '<td style="border: 1px solid #ddd; padding: 8px;">' + escapeHtml(cert.main_domain || 'N/A') + '</td>';
                        html += '<td style="border: 1px solid #ddd; padding: 8px;">' + escapeHtml(cert.alternatives ? cert.alternatives.join(', ') : 'None') + '</td>';
                        html += '<td style="border: 1px solid #ddd; padding: 8px;">' + escapeHtml(cert.issuer || 'N/A') + '</td>';
                        html += '<td style="border: 1px solid #ddd; padding: 8px;">' + escapeHtml(cert.valid_until || 'N/A') + '</td>';
                        html += '</tr>';
                    });

                    html += '</tbody></table>';
                    container.innerHTML = html;

                } else if (data.success && data.certificates.length === 0 && data.message) {
                     container.innerHTML = '<p>' + escapeHtml(data.message) + '</p>';
                }
                else {
                    container.innerHTML = '<p style="color:red;">Error loading certificate information: ' + escapeHtml(data.error || data.details || 'Unknown error') + '</p>';
                     if(data.details) { 
                        container.innerHTML += '<pre style="background-color: #f8f9fa; padding: 10px; border-radius: 4px;">' + escapeHtml(data.details) + '</pre>';
                     }
                }
            } catch (error) {
                console.error('Error fetching certificate info:', error);
                container.innerHTML = '<p style="color:red;">Client-side error fetching certificate information. Check console.</p>';
                displayMessage('Network error or server not responding while fetching certificate info.', 'danger');
            }
        }

        // --- Log Viewer Script ---
        async function fetchLogs() {
            const logType = document.getElementById('log_type_select').value;
            const lines = document.getElementById('log_lines_input').value;
            const logContentArea = document.getElementById('log-content-area');

            logContentArea.textContent = 'Fetching log (' + logType + ', ' + lines + ' lines)...';
            displayMessage('Fetching log: ' + logType + '...', 'info');

            try {
                // Ensure lines is a positive integer, default if not.
                const numLines = parseInt(lines, 10);
                if (isNaN(numLines) || numLines <= 0) {
                    displayMessage('Number of lines must be a positive integer.', 'danger');
                    logContentArea.textContent = 'Invalid number of lines specified.';
                    return;
                }

                const response = await fetch('/api/logs/' + logType + '?lines=' + numLines);
                const data = await response.json();

                if (data.success) {
                    logContentArea.textContent = data.content ? escapeHtml(data.content) : 'Log is empty or no content returned.';
                    // Check if the script itself returned an error message within the content
                    if (data.content && data.content.trim().toUpperCase().startsWith("ERROR:")) {
                         displayMessage('Successfully fetched log, but script reported an error: ' + data.content.split('\n')[0], 'warning');
                    } else {
                        displayMessage('Log content loaded for ' + logType + '.', 'success');
                    }
                } else {
                    const errorMessage = data.error || 'Unknown error fetching logs.';
                    logContentArea.textContent = 'Error loading logs for ' + logType + ':\n' + escapeHtml(errorMessage);
                    displayMessage('Failed to load logs for ' + logType + ': ' + errorMessage, 'danger');
                }
            } catch (error) {
                console.error('Error fetching logs:', error);
                logContentArea.textContent = 'Client-side error fetching logs for ' + logType + '. Check console.';
                displayMessage('Network error or server not responding while fetching logs.', 'danger');
            }
        }

    </script>
</body>
</html>
